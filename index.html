<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Parc Ambiental del Bages en VR</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style> body { margin: 0; } </style>
</head>
<body>
  <a-scene cursor="rayOrigin: mouse">
    <a-assets>
      <!-- Panorama / imágenes (usa las que aparecen en tu captura) -->
      <!-- Ajusta los nombres si en tu sistema tienen el sufijo _1 o espacios -->
      <img id="scene-general" src="assets/imatges/0_1general.jpg">
      <img id="scene-oficines" src="assets/imatges/1_oficines.jpg">
      <img id="scene-abocador" src="assets/imatges/2_abocador.jpg">
      <img id="scene-plantatransferencia" src="assets/imatges/3_plantatransferencia.jpg">
      <img id="scene-motorbiogas" src="assets/imatges/4_motorbiogas.jpg">
      <img id="scene-bassesdaigues" src="assets/imatges/5_bassesdaigues.jpg">
      <img id="scene-parcsolar" src="assets/imatges/6_parcsolar.jpg">
      <img id="scene-plantacompostatge" src="assets/imatges/7_plantacompostatge.jpg">
      <img id="scene-novaplanta" src="assets/imatges/8_novaplanta.jpg">

      <!-- plano y banderas (igual que antes, dejadas tal cual) -->
      <img id="dibuplano" src="assets/imatges/plano.jpg">
      <img id="bes" src="assets/imatges/bes.png">
      <img id="bcat" src="assets/imatges/bcat.png">
      <img id="buk" src="assets/imatges/buk.png">
    </a-assets>

    <!-- cámara -->
    <a-entity camera look-controls wasd-controls="false"></a-entity>

    <!-- sky inicial (pantalla de presentación) -->
    <a-sky id="sky" src="#scene-general"></a-sky>

    <!-- banderas para seleccionar idioma -->
    <a-plane id="es" position="-1.6 -0.6 -2" src="#bes" rotation="0 0 0" scale="1 1 1" class="langButton"></a-plane>
    <a-plane id="cat" position="0 -0.6 -2" src="#bcat" rotation="0 0 0" scale="1 1 1" class="langButton"></a-plane>
    <a-plane id="uk" position="1.6 -0.6 -2" src="#buk" rotation="0 0 0" scale="1 1 1" class="langButton"></a-plane>

    <!-- plano (visibilidad controlada por JS) -->
    <a-plane id="plano" position="0 -1 -2" src="#dibuplano" rotation="0 0 0" scale="2 1 2" visible="false"></a-plane>

    <!-- entidad de sonido; no predefinimos la src porque la cargamos dinámicamente -->
    <a-entity id="sound" sound="autoplay: false"></a-entity>

  </a-scene>

  <script>
    // Elementos DOM
    const sky = document.querySelector('#sky');
    const sound = document.querySelector('#sound');
    const banderaEs = document.querySelector('#es');
    const banderaCat = document.querySelector('#cat');
    const banderaUk = document.querySelector('#uk');
    const mapa = document.querySelector('#plano');

    // Idioma por defecto
    let idioma = "ca"; // ca / es / uk

    // Mapa lógico de escenas -> imágenes (ids de a-assets)
    const scenes = {
      general: '#scene-general',
      oficines: '#scene-oficines',
      abocador: '#scene-abocador',
      plantatransferencia: '#scene-plantatransferencia',
      motorbiogas: '#scene-motorbiogas',
      bassesdaigues: '#scene-bassesdaigues',
      parcsolar: '#scene-parcsolar',
      planta_compostatge: '#scene-plantacompostatge',
      nova_planta: '#scene-novaplanta'
    };

    // Mapa lógico escena -> nombre base de audio (archivo sin carpeta ni extensión)
    // Ajusta estos valores si tus audios tienen nombres distintos.
    const audioMap = {
      general: 'cetreria',                 // ejemplo: assets/audios/ca/cetreria.mp3
      oficines: 'oficina',                // assets/audios/ca/oficina.mp3
      abocador: 'vertedero',              // assets/audios/ca/vertedero.mp3
      plantatransferencia: 'vidre_i_envasos', // assets/audios/ca/vidre_i_envasos.mp3
      motorbiogas: 'biogas',
      bassesdaigues: 'aigues_pluvials',
      parcsolar: 'parc_solar',
      planta_compostatge: 'planta_compostatge',
      nova_planta: 'planta_valoritzacio'  // adapta tilde/ç si hace falta en tu FS
    };

    // función genérica para cambiar escena y (opcionalmente) reproducir audio asociado
    function setScene(key, playAudioToo = true) {
      if (!scenes[key]) {
        console.warn('Escena no encontrada:', key);
        return;
      }
      // cambiar sky
      sky.setAttribute('src', scenes[key]);

      // stop previo
      if (sound.components && sound.components.sound && sound.components.sound.isPlaying) {
        sound.components.sound.stopSound();
      }

      // si hay audio asociado y el flag lo permite, reproducir
      const audioNombre = audioMap[key];
      if (playAudioToo && audioNombre) {
        // ruta completa a archivo mp3 (idioma variable)
        // Nota: los audios deben estar en assets/audios/<idioma>/<audioNombre>.mp3
        const ruta = `assets/audios/${idioma}/${audioNombre}.mp3`;
        // establecemos el atributo sound a la ruta (A-Frame acepta URL directa)
        sound.setAttribute('sound', `src: ${ruta}; autoplay: false`);
        // A-Frame necesita que el componente sound esté cargado antes de reproducir:
        // esperamos un tick para que el componente se inicialice
        setTimeout(() => {
          try {
            if (sound.components.sound) sound.components.sound.playSound();
          } catch (err) {
            console.error('No se ha podido reproducir el audio:', err);
          }
        }, 100);
      }
    }

    // Helpers para los botones de idioma (se mantiene lógica anterior)
    function onSelectLanguage(lang) {
      idioma = lang;
      // al seleccionar idioma mostramos la escena "general" y ocultamos banderas
      setScene('general', true);
      banderaEs.setAttribute('visible', false);
      banderaCat.setAttribute('visible', false);
      banderaUk.setAttribute('visible', false);
      mapa.setAttribute('visible', true);
    }

    // Registra clicks
    banderaEs.addEventListener('click', () => onSelectLanguage('es'));
    banderaCat.addEventListener('click', () => onSelectLanguage('ca'));
    banderaUk.addEventListener('click', () => onSelectLanguage('uk'));

    // --- Opcional: ejemplo para cambiar escena desde mapa (si quieres) ---
    // Puedes añadir planos invisibles sobre el mapa con id's y eventos click que llamen:
    // setScene('oficines');
    // setScene('abocador');
    // etc.

    // Inicial: muestra la general (sin reproducir) — o quítalo si prefieres pantalla en negro
    sky.setAttribute('src', scenes.general);

    // Elimina el movimiento con WASD como tenías antes (por seguridad)
    const cam = document.querySelector('[camera]');
    if (cam) cam.removeAttribute('wasd-controls');
  </script>
</body>
</html>
